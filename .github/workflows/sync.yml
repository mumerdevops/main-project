name: Quality Gate and Sync

on:
  push:
    branches:
      - main

jobs:
  # JOB 1: Analysis (The Checkpoint)
  analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Updated to latest version
        with:
          fetch-depth: 0 

      - name: SonarCloud Scan
        # Updated from deprecated sonarcloud-github-action to the new version
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # These arguments fix the "mandatory properties" error
          args: >
            -Dsonar.projectKey=mumerdevops_main-project
            -Dsonar.organization=mumerdevops
            -Dsonar.sources=.
            -Dsonar.host.url=https://sonarcloud.io

  # JOB 2: Sync (The Backup)
  sync:
    needs: analysis 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Mirror to Backup Repository
        run: |
          git config --global user.email "muhammadumer5689@gmail.com"
          git config --global user.name "mumerdevops"
          
          # Use the PAT for authentication
          git clone "https://x-access-token:${{ secrets.PAT }}@github.com/mumerdevops/backup-project.git" backup-dir
          cd backup-dir
          git remote add source-repo "https://x-access-token:${{ secrets.PAT }}@github.com/mumerdevops/main-project.git"
          git fetch source-repo
          git checkout main
          git reset --hard source-repo/main
          git push origin main --force
